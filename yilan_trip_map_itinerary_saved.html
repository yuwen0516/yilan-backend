<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>å®œè˜­æ—…éŠè¦åŠƒåœ°åœ–</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
  <style>
    #map { height: 400px; border: 2px solid #ff9800; border-radius: 8px; }
    .remove-btn { float: right; cursor: pointer; color: red; }
  </style>
</head>
<body class="p-4">
  <h3>ğŸŒ å®œè˜­æ™¯é»åœ°åœ–è¦åŠƒå·¥å…·</h3>

  <div class="mb-3">
    <label for="day-selector" class="form-label"><strong>é¸æ“‡åŠ å…¥å¤©æ•¸ï¼š</strong></label>
    <select id="day-selector" class="form-select" style="width: 150px;">
      <option value="1">Day 1</option>
      <option value="2">Day 2</option>
      <option value="3">Day 3</option>
    </select>
  </div>

  
<div class="mb-3">
  <h5>ğŸ” è‡ªè¨‚æ™¯é»åŠ å…¥è¡Œç¨‹</h5>
  <input type="text" id="custom-place-name" class="form-control mb-2" placeholder="è¼¸å…¥æ™¯é»åç¨±" />
  <input type="text" id="custom-place-category" class="form-control mb-2" placeholder="è¼¸å…¥åˆ†é¡ï¼Œå¦‚ è‡ªç„¶æ™¯é»ã€æ–‡åŒ–æ™¯é»..." />
  <button class="btn btn-success" onclick="addCustomPlace()">â• åŠ å…¥è‡ªè¨‚æ™¯é»</button>
</div>
<div id="map" class="mb-4"></div>

  <h5>ğŸ“ å·²åŠ å…¥è¡Œç¨‹</h5>
  <ul id="itinerary-list" class="list-group"></ul>

<div class="mt-3">
  <button class="btn btn-primary" onclick="saveItinerary()">ğŸ’¾ å„²å­˜è¡Œç¨‹</button>
  <button class="btn btn-secondary" onclick="clearItinerary()">ğŸ—‘ï¸ æ¸…é™¤è¡Œç¨‹</button>
</div>
<hr/>
<h5>ğŸ“œ æ­·å²è¡Œç¨‹ç´€éŒ„</h5>
<div id="history-list" class="mt-3"></div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const scheduleData = { 1: [], 2: [], 3: [] };

let map;
function initMap() {
  map = L.map('map').setView([24.75, 121.75], 10);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  attractions.forEach((loc, index) => {
    const popupHtml = `
      <div>
        <strong>${loc.name}</strong><br/>
        <small>${loc.category}</small><br/>
        <button class="btn btn-sm btn-primary mt-1" onclick="addPlaceFromMap(${index})">â• åŠ å…¥è¡Œç¨‹</button>
      </div>
    `;
    L.marker([loc.lat, loc.lng])
      .addTo(map)
      .bindPopup(popupHtml);
  });
}

const attractions = [
      {"name": "è˜­é™½åšç‰©é¤¨", "lat": 24.8694, "lng": 121.8311, "category": "åšç‰©é¤¨"},
    {"name": "äº”å³°æ——ç€‘å¸ƒ", "lat": 24.8278, "lng": 121.7728, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "ç¾…æ±å¤œå¸‚", "lat": 24.6768, "lng": 121.7666, "category": "å¤œå¸‚ç¾é£Ÿ"},
    {"name": "é¾œå±±å³¶", "lat": 24.8323, "lng": 121.9593, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "æ¢…èŠ±æ¹–", "lat": 24.6995, "lng": 121.7388, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "å‚³çµ±è—è¡“ä¸­å¿ƒ", "lat": 24.6853, "lng": 121.8322, "category": "æ–‡åŒ–æ™¯é»"},
    {"name": "ç¤æºªæº«æ³‰", "lat": 24.8258, "lng": 121.7742, "category": "æº«æ³‰"},
    {"name": "æ¸…æ°´åœ°ç†±", "lat": 24.7607, "lng": 121.6719, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "å—æ–¹æ¾³è§€æ™¯å°", "lat": 24.5945, "lng": 121.8530, "category": "æ™¯è§€å¹³å°"},
    {"name": "é ­åŸè€è¡—", "lat": 24.8575, "lng": 121.8305, "category": "æ­·å²æ™¯é»"},
    {"name": "å®œè˜­é…’å» ", "lat": 24.7510, "lng": 121.7554, "category": "æ–‡åŒ–æ™¯é»"},
    {"name": "å†¬å±±æ²³è¦ªæ°´å…¬åœ’", "lat": 24.6725, "lng": 121.7905, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "æ±é–€å¤œå¸‚", "lat": 24.7542, "lng": 121.7548, "category": "å¤œå¸‚ç¾é£Ÿ"},
    {"name": "ä½›å…‰å¤§å­¸", "lat": 24.8189, "lng": 121.7189, "category": "å­¸è¡“å»ºç¯‰"},
    {"name": "å®œè˜­è¨­æ²»ç´€å¿µé¤¨", "lat": 24.7541, "lng": 121.7561, "category": "æ­·å²å»ºç¯‰"},
    {"name": "å¹¾ç±³å…¬åœ’", "lat": 24.7507, "lng": 121.7580, "category": "ä¸»é¡Œå…¬åœ’"},
    {"name": "æœ›é¾åŸ¤", "lat": 24.7137, "lng": 121.7208, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "å¤ªå¹³å±±æ£®æ—éŠæ¨‚å€", "lat": 24.4862, "lng": 121.5323, "category": "è‡ªç„¶æ™¯é»"},
    {"name": "ä¸‰æ˜Ÿè”¥æ–‡åŒ–é¤¨", "lat": 24.6778, "lng": 121.6559, "category": "æ–‡åŒ–æ™¯é»"},
    {"name": "æ£²è˜­æ£®æ—éŠæ¨‚å€", "lat": 24.6027, "lng": 121.4835, "category": "è‡ªç„¶æ™¯é»"},
    ];

function addPlaceFromMap(index) {
  const day = parseInt(document.getElementById('day-selector').value);
  const loc = attractions[index];
  const place = {
    id: Date.now() + Math.random(),
    name: loc.name,
    category: loc.category,
    note: '',
    day: day
  };
  scheduleData[day].push(place);
  renderItinerary();
  map.closePopup();
}

function addCustomPlace() {
  const name = document.getElementById('custom-place-name').value.trim();
  const category = document.getElementById('custom-place-category').value.trim() || 'æœªåˆ†é¡';
  const day = parseInt(document.getElementById('day-selector').value);
  if (!name) return alert('è«‹è¼¸å…¥æ™¯é»åç¨±');
  scheduleData[day].push({
    id: Date.now(),
    name,
    category,
    note: '',
    day
  });
  renderItinerary();
}

function renderItinerary() {
  const list = document.getElementById("itinerary-list");
  list.innerHTML = '';
  for (let day = 1; day <= 3; day++) {
    if (scheduleData[day].length > 0) {
      const header = document.createElement('li');
      header.className = 'list-group-item active';
      header.textContent = `ç¬¬ ${day} å¤©`;
      list.appendChild(header);
      scheduleData[day].forEach(p => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `ğŸ“ ${p.name} (${p.category})`;
        list.appendChild(li);
      });
    }
  }
}

function saveItinerary() {
  const name = prompt("è«‹è¼¸å…¥è¡Œç¨‹åç¨±");
  if (!name) return alert("âŒ è«‹è¼¸å…¥è¡Œç¨‹åç¨±");

  const payload = {
    name: name,
    schedule: scheduleData
  };

  fetch("save_trip.php", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("âœ… è¡Œç¨‹å·²æˆåŠŸå„²å­˜ï¼");
      loadTripHistory();
    } else {
      alert("âŒ å„²å­˜å¤±æ•—ï¼š" + data.error);
    }
  })
  .catch(err => {
    alert("âŒ éŒ¯èª¤ï¼š" + err.message);
  });
}

function clearItinerary() {
  if (!confirm("ä½ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¡Œç¨‹å—ï¼Ÿ")) return;
  for (let day = 1; day <= 3; day++) {
    scheduleData[day] = [];
  }
  renderItinerary();
}

function loadTripHistory() {
  fetch("get_trips.php")
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById("history-list");
      container.innerHTML = "";

      if (data.success && data.trips.length > 0) {
        data.trips.forEach(trip => {
          const div = document.createElement("div");
          div.className = "border p-2 mb-2";
          let daysHTML = "";
          for (const day in trip.schedule) {
            const items = trip.schedule[day]
              .map(p => `<li>${p.name} (${p.category})</li>`)
              .join('');
            daysHTML += `<strong>ç¬¬${day}å¤©ï¼š</strong><ul>${items}</ul>`;
          }
          div.innerHTML = `<h5>${trip.name}</h5>${daysHTML}`;
          container.appendChild(div);
        });
      } else {
        container.innerHTML = "<p class='text-muted'>å°šç„¡æ­·å²ç´€éŒ„</p>";
      }
    })
    .catch(err => {
      alert("âŒ è¼‰å…¥æ­·å²ç´€éŒ„éŒ¯èª¤ï¼š" + err.message);
    });
}

window.onload = function () {
  initMap();
  renderItinerary();
  loadTripHistory();
};
</script>

</body>
</html>
